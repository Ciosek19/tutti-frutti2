<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Tutti Frutti - Juego</title>
  </head>
  <body>
    <div id="cuenta-regresiva-inicial">
      <h1 id="numero-cuenta">3</h1>
    </div>

    <div id="contenido-juego" style="display: none">
      <h1>TUTTI FRUTTI</h1>

      <button type="button" id="btnSalir" onclick="confirmarSalida()">Salir al Menú</button>

      <div th:if="${partida != null}">
        <div id="temporizador">
          Tiempo restante: <span id="tiempo">--</span> segundos
        </div>
        <h2>Tu letra es: <span th:text="${partida.letra}"></span></h2>

        <form id="formularioPartida" action="/solitario/validar" method="POST">
          <input type="hidden" name="letra" th:value="${partida.letra}" />

          <div th:each="categoria : ${partida.categorias}">
            <label th:text="${categoria} + ':'"></label>
            <input
              type="text"
              th:name="${categoria}"
              th:placeholder="${partida.letra}"
              class="input-categoria"
            />
            <br /><br />
          </div>

          <button type="submit" id="btnEnviar">TUTTI FRUTTI</button>
        </form>
      </div>

      <div th:if="${partida == null}">
        <p>
          No se pudo cargar la partida.
          <a href="/solitario">Volver a intentar</a>
        </p>
      </div>
    </div>

    <script th:inline="javascript">
      /*<![CDATA[*/
      let tiempoRestante = /*[[${partida.duracion}]]*/ 120;

      const temporizadorElemento = document.getElementById("tiempo");
      const formulario = document.getElementById("formularioPartida");
      const cuentaRegresiva = document.getElementById(
        "cuenta-regresiva-inicial"
      );
      const numeroCuenta = document.getElementById("numero-cuenta");
      const contenidoJuego = document.getElementById("contenido-juego");
      const btnEnviar = document.getElementById("btnEnviar");
      const inputsCategorias = document.querySelectorAll(".input-categoria");

      let intervaloPartida = null;

      // Función para verificar si todos los campos tienen valor
      function verificarCamposCompletos() {
        let todosCompletos = true;
        inputsCategorias.forEach((input) => {
          if (input.value.trim() === "") {
            todosCompletos = false;
          }
        });

        // Habilitar o deshabilitar el botón según el estado de los campos
        btnEnviar.disabled = !todosCompletos;
      }

      // Agregar listeners a todos los inputs para verificar en tiempo real
      inputsCategorias.forEach((input) => {
        input.addEventListener("input", verificarCamposCompletos);
      });

      async function iniciarJuego() {
        await iniciarCuentaRegresiva();
        ocultarCuentaRegresiva();
        mostrarJuego();
        iniciarTemporizadorPartida();
      }

      function iniciarCuentaRegresiva() {
        return new Promise((resuelve) => {
          let contador = 3;
          const intervaloCuentaInicial = setInterval(() => {
            if (contador > 0) {
              numeroCuenta.textContent = contador;
              contador--;
            } else {
              numeroCuenta.textContent = "¡YA!";
              clearInterval(intervaloCuentaInicial);
              resuelve();
            }
          }, 1000);
        });
      }

      function ocultarCuentaRegresiva() {
        cuentaRegresiva.style.display = "none";
      }

      function mostrarJuego() {
        contenidoJuego.style.display = "block";

        // Deshabilitar el botón al inicio
        btnEnviar.disabled = true;

        if (inputsCategorias.length > 0) {
          inputsCategorias[0].focus();
        }
      }

      function iniciarTemporizadorPartida() {
        actualizarTemporizador();
        intervaloPartida = setInterval(actualizarTemporizador, 1000);
      }

      function actualizarTemporizador() {
        temporizadorElemento.textContent = tiempoRestante;

        if (tiempoRestante <= 0) {
          detenerTemporizador();
          alert("¡Tiempo terminado!");
          formulario.submit();
          return;
        }

        tiempoRestante--;
      }

      function detenerTemporizador() {
        if (intervaloPartida) {
          clearInterval(intervaloPartida);
          intervaloPartida = null;
        }
      }

      formulario.addEventListener("submit", function (e) {
        detenerTemporizador();
      });

      function confirmarSalida() {
        const confirmacion = confirm("¿Estás seguro de que quieres salir? Perderás el progreso de esta partida.");
        if (confirmacion) {
          detenerTemporizador();
          window.location.href = "/menu";
        }
      }

      window.addEventListener("load", () => {
        iniciarJuego();
      });
      /*]]>*/
    </script>
  </body>
</html>
